<div id="page-wrapper">
<div class="container-fluid">
<div class="page-title"><?= $page_title ?></div>
<div class="content">
	<div class="tabs" data-id="asd">
		<div class="tabs-header">
			<div class="tabs-item-container">
				<div class="tabs-item active" data-tabs-number="1">Konfirmasi (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="2">Pending (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="3">Door 1 (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="4">Port 1 (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="5">Port 2 (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="6">Door 2 (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="7">Selesai (<span class="tabs-item-count">0</span>)</div>
				<div class="tabs-item" data-tabs-number="8">Cancel (<span class="tabs-item-count">0</span>)</div>
			</div>
			<div class="tabs-selection"></div>
		</div>
		<div class="tabs-body">
			<div class="tabs-content active" data-tabs-number="1">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td data-align="center">Konfirmasi</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="2">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Action</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="3">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Action</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="4">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Action</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="5">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Action</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="6">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Action</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="7">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Kapal</td>
								<td>No. Kontainer</td>
								<td>Status</td>
								<td data-align="center">Total Waktu</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
			<div class="tabs-content" data-tabs-number="8">
				<div class="table-container">
					<table class="table table-kiriman">
						<thead>
							<tr>
								<td data-align="center">Nama Kirim</td>
								<td>Harga</td>
								<td>Asal</td>
								<td>Tujuan</td>
								<td data-align="center">KM</td>
								<td>Cancel by</td>
							</tr>
						</thead>
						<tbody class="tbody-kiriman">
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<div class="dialog-background">
	<div class="dialog dialog-konfirmasi-cancel-transaction">
		<div class="dialog-header">
			<div class="dialog-title">Pembatalan Kiriman</div>
		</div>
		<div class="dialog-body">
			<div></div>
		</div>
		<div class="dialog-footer">
			<button type="button" class="btn-negative btn-submit-cancel-transaction">Batalkan Kiriman</button>
			<button type="button" class="btn-neutral btn-batal">Tidak Jadi</button>
		</div>
	</div>
</div>
</div>
</div>
<script>
var month = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
var kirimanUrl = [];
kirimanUrl[1] = "<?= base_url("kiriman-laut-ekspedisi/getDealKiriman") ?>";
kirimanUrl[2] = "<?= base_url("kiriman-laut-ekspedisi/getPendingKiriman") ?>";
kirimanUrl[3] = "<?= base_url("kiriman-laut-ekspedisi/getDoorAwalKiriman") ?>";
kirimanUrl[4] = "<?= base_url("kiriman-laut-ekspedisi/getPortAwalKiriman") ?>";
kirimanUrl[5] = "<?= base_url("kiriman-laut-ekspedisi/getPortAkhirKiriman") ?>";
kirimanUrl[6] = "<?= base_url("kiriman-laut-ekspedisi/getDoorAkhirKiriman") ?>";
kirimanUrl[7] = "<?= base_url("kiriman-laut-ekspedisi/getSelesaiKiriman") ?>";
kirimanUrl[8] = "<?= base_url("kiriman-laut-ekspedisi/getCancelKiriman") ?>";

var kirimanTabs = [];
kirimanTabs[1] = "deal";
kirimanTabs[2] = "pending";
kirimanTabs[3] = "door1";
kirimanTabs[4] = "port1";
kirimanTabs[5] = "port2";
kirimanTabs[6] = "door2";
kirimanTabs[7] = "selesai";
kirimanTabs[8] = "cancel";

var kendaraan = [], supir = [], alat = [];
	
$(function() {
	
	getKirimanCount();
	getKiriman(kirimanUrl[1], 1, "deal");
	
	$(".tabs-item").on("click", function() {
		var tabsNumber = $(this).data("tabs-number");
		getKiriman(kirimanUrl[tabsNumber], tabsNumber, kirimanTabs[tabsNumber]);
	});
	
	$(document).on("click", ".btn-deal", function() {
		submitDeal(this);
	});
	
	$(document).on("click", ".btn-ubah", function() {
		
	});
	
	$(document).on("click", ".btn-batal-pengiriman", function() {
		var shipment_id = $(this).closest(".tr-kiriman").data("id");
		var shipment_title = $(this).closest(".tr-kiriman").data("shipment-title");
		
		$(".dialog-konfirmasi-cancel-transaction").data("shipment_id", shipment_id);
		$(".dialog-konfirmasi-cancel-transaction .dialog-body").html("Batalkan kiriman " + shipment_title + "?");
		showDialog(".dialog-konfirmasi-cancel-transaction");
	});
	
	$(".btn-submit-cancel-transaction").on("click", function() {
		cancelShipment();
	});
});

function cancelShipment() {
	var shipment_id = $(".dialog-konfirmasi-cancel-transaction").data("shipment_id");
	ajaxCall("<?= base_url("kiriman-laut-ekspedisi/cancelShipment") ?>", {shipment_id: shipment_id}, function(result) {
		if (result == "success") {
			closeDialog();
			refreshData();
		}
	});
}

function getKendaraan() {
	/*ajaxCall("<?= base_url("kiriman-laut-ekspedisi/getKendaraan") ?>", null, function(json) {
		var result = jQuery.parseJSON(json);
			
		var element = "";
		var iLength = result.length;
		for (var i = 0; i < iLength; i++) {
			kendaraan.push({
				id: result[i].vehicle_id,
				name: result[i].vehicle_name
			});
			element += "<option value='" + result[i].vehicle_id + "'>" + result[i].vehicle_name + "</option>";
		}
		$(".select-kendaraan").append(element);
	});*/
}



function submitDeal(element) {
	var shipment_id = $(element).closest(".tr-kiriman").data("id");
	var data = {
		shipment_id: shipment_id
	};
	ajaxCall("<?= base_url("kiriman-laut-ekspedisi/submitDeal") ?>", data, function(result) {
		if (result == "success") {
			refreshData();
		} else {
			alert(result);
		}
	});
}

function refreshData() {
	getKirimanCount();
	var tabsNumber = $(".tabs-item.active").data("tabs-number");
	getKiriman(kirimanUrl[tabsNumber], tabsNumber, kirimanTabs[tabsNumber]);
}

function getKirimanCount() {
	ajaxCall("<?= base_url("kiriman-laut-ekspedisi/getKirimanSaya") ?>", null, function(json) {
		var result = jQuery.parseJSON(json);
		assignKirimanCount(result);
	});
}

function assignKirimanCount(result) {
	var tabs = {
		t1: 0,
		t2: 0,
		t3: 0,
		t4: 0,
		t5: 0,
		t6: 0,
		t7: 0,
		t8: 0
	};
	
	for (var i = 0; i < result.length; i++) {
		switch (result[i].shipment_status) {
			case "0":
				tabs.t1 = result[i].count;
				break;
			case "1":
				tabs.t2 = result[i].count;
				break;
			case "2":
				tabs.t3 = result[i].count;
				break;
			case "3":
				tabs.t4 = result[i].count;
				break;
			case "4":
				tabs.t5 = result[i].count;
				break;
			case "5":
				tabs.t6 = result[i].count;
				break;
			case "6":
				tabs.t7 = result[i].count;
				break;
			case "7":
				tabs.t8 = result[i].count;
				break;
		}
	}
	
	for (var i = 1; i <= 8; i++) {
		updateTabsItemCount(i, tabs["t" + i]);
	}
}

function getKiriman(url, tabsNumber, tabs) {
	ajaxCall(url, null, function(json) {
		var result = jQuery.parseJSON(json);
		addKirimanToTable(result, tabsNumber, tabs);
	});
}

function addKirimanToTable(result, tabsNumber, tab) {
	var iLength = result.length;
	var element = {
		"deal": {
			value: "",
			btn: "<td><button class='btn-default btn-action btn-deal'>Deal</button><button class='btn-negative btn-action btn-batal-pengiriman'>Tolak</button></td>"
		},
		"pending": {
			value: "",
			btn: "<td><button class='btn-default btn-action btn-ubah'>Ubah</button><button class='btn-negative btn-action btn-batal-pengiriman'>Batalkan</button></td>"
		},
		"door1": {
			value: "",
			btn: "<td><button class='btn-default btn-action btn-ubah'>Ubah</button><button class='btn-negative btn-action btn-batal-pengiriman'>Batalkan</button></td>"
		},
		"port1": {
			value: "",
			btn: "<td><button class='btn-default btn-action btn-ubah'>Ubah</button><button class='btn-negative btn-action btn-batal-pengiriman'>Batalkan</button></td>"
		},
		"port2": {
			value: "",
			btn: "<td><button class='btn-default btn-action btn-ubah'>Ubah</button><button class='btn-negative btn-action btn-batal-pengiriman'>Batalkan</button></td>"
		},
		"door2": {
			value: "",
			btn: "",
		},
		"selesai": {
			value: "",
			btn: ""
		},
		"cancel": {
			value: "",
			btn: ""
		}
	};
	
	for (var i = 0; i < iLength; i++) {
		
		var date_from = new Date(result[i].shipment_delivery_date_from);
		var fullDateFrom = date_from.getDate() + " " + month[date_from.getMonth()] + " " + date_from.getFullYear();
		var date_to = new Date(result[i].shipment_delivery_date_to);
		var fullDateTo = date_to.getDate() + " " + month[date_to.getMonth()] + " " + date_to.getFullYear();
		
		var additionalTd = "";
		var tdStatus = "";
		var tdCancelBy = "";
		var waktu = "";
		switch (tab) {
			case "deal":
				
				break;
			case "pending":
				additionalTd = "<td><select class='select-kapal'><option value='1'>Meratus</option><option value='2'>SPIL</option></select></td><td><input type='text' class='input-no-kontainer' maxlength='11' /></td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				break;
			case "door1":
				additionalTd = "<td>" + result[i].driver_names + "</td><td>" + result[i].vehicle_names + "</td><td>" + result[i].device_names + "</td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				break;
			case "port1":
				additionalTd = "<td>" + result[i].driver_names + "</td><td>" + result[i].vehicle_names + "</td><td>" + result[i].device_names + "</td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				break;
			case "port2":
				additionalTd = "<td>" + result[i].driver_names + "</td><td>" + result[i].vehicle_names + "</td><td>" + result[i].device_names + "</td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				break;
			case "door2":
				additionalTd = "<td>" + result[i].driver_names + "</td><td>" + result[i].vehicle_names + "</td><td>" + result[i].device_names + "</td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				break;
			case "selesai":
				additionalTd = "<td>" + result[i].driver_names + "</td><td>" + result[i].vehicle_names + "</td><td>" + result[i].device_names + "</td>";
				tdStatus = "<td>D1 &rarr; P1 &rarr; P2 &rarr; D2</td>";
				waktu = "<td data-align='center'>" + result[i].waktu_kiriman + " hari</td><td data-align='center'>" + result[i].total_waktu + " hari</td>";
				break;
			case "cancel":
				tdCancelBy = "<td class='td-cancel_by'>" + result[i].cancel_username + "</td>";
				break;
		}
		
		element[tab].value += "<tr class='tr-kiriman' data-id='" + result[i].shipment_id + "' data-shipment-title='" + result[i].shipment_title + "'><td class='td-title' data-align='center'><a href='<?= base_url("kirim/detail/") ?>" + result[i].shipment_id + "'>" + result[i].shipment_title + "<img class='shipment-picture' src='<?= base_url("assets/panel/images/") ?>" + result[i].shipment_pictures + "' /></a></td><td class='td-price'>Bid : " + result[i].bidding_count + "<br>Low : " + addCommas(result[i].low) + " IDR</td><td class='td-asal'>" + result[i].location_from_city + "<br>" + fullDateFrom + " - " + fullDateTo + "</td><td class='td-tujuan'>" + result[i].location_to_city + "<br>" + fullDateFrom + " - " + fullDateTo + "</td><td class='td-km' data-align='center'>" + parseInt(result[i].shipment_length) + "</td>" + tdCancelBy + additionalTd + tdStatus + element[tab].btn + waktu + "</tr>";
	}
	
	$(".tabs-content[data-tabs-number='" + tabsNumber + "'] .tbody-kiriman").html("");
	$(".tabs-content[data-tabs-number='" + tabsNumber + "'] .tbody-kiriman").append(element[tab].value);
	
	if (tab == "pending" && iLength > 0) {
		getKendaraan();
	}
}
</script>